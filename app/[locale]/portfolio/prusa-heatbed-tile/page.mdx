import Link from 'next/link'
import { getDictionary } from '../../../i18n/getDictionary'
import PCBViewer from '../../../components/PCBViewer'

export async function generateMetadata({ params }) {
  return {
    title: 'Prusa HeatBed Tile PCB',
    description: 'ESP32-S3 based control PCB with USB-C PD input and Hall effect weight detection.'
  }
}

export default async function Page({ params }) {
  const locale = params?.locale || 'en'
  const t = await getDictionary(locale)

  return (
    <article className="max-w-4xl">
      <p className="mb-4">
        <Link href={`/${locale}/portfolio`} className="nav-link">
          ‚Üê {t.common.backToPortfolio}
        </Link>
      </p>
      
      <h1 className="text-4xl md:text-5xl font-bold text-neutral-900 dark:text-white mb-4">
        Prusa HeatBed Tile PCB
      </h1>
      
      <p className="text-xl text-neutral-600 dark:text-neutral-300 mb-8">
        ESP32-S3 based control PCB with USB-C PD input and Hall effect weight detection.
      </p>

      {/* 3D PCB Viewer */}
      <div className="mb-8">
        <PCBViewer stepFile="/models/coaster.glb" />
      </div>

      <div className="prose prose-neutral dark:prose-invert max-w-none">
        <h2>Overview</h2>
        <p>A compact, ESP32-S3 based control PCB designed for Prusa-style heated bed tile coasters. It supports USB-C Power Delivery input and integrates weight detection using a Hall effect sensor for interactive beverage detection. This project demonstrates advanced power management and sensor integration in a small form factor.</p>

        <h2>Design Philosophy</h2>
        <p>Compactness and smart functionality define this design. By integrating Hall effect detection directly on the PCB, we created a system that can intelligently detect when a beverage is placed, enabling automated heating cycles and energy-efficient operation.</p>

        <h2>Key Features</h2>
        <ul>
          <li><strong>ESP32-S3-WROOM-1-N8:</strong> Wi-Fi and Bluetooth LE connectivity</li>
          <li><strong>USB-C Power Delivery:</strong> Negotiates up to 20 V using CH221K</li>
          <li><strong>Weight Detection:</strong> Hall effect sensor (DRV5032FAQDBZR) detects vertical movement</li>
          <li><strong>Power Management:</strong> 5 V buck converter (AP3503) and 3.3 V LDO (AP2112K)</li>
          <li><strong>MOSFET Control:</strong> Logic-level MOSFET (HY1904C2) for heating tile</li>
        </ul>

        <h2>Technical Implementation</h2>
        <h3>Detection Mechanism</h3>
        <p>When a beverage (like a cup of tea) is placed on the coaster, weight causes the platform to compress slightly. This vertical motion brings a magnet closer to the Hall effect sensor mounted on the bottom of the PCB. When magnetic polarity aligns properly, the Hall sensor outputs a signal indicating presence of cup.</p>

        <h3>Power Architecture</h3>
        <p>The multi-stage power design ensures efficient and reliable operation:</p>
        <ul>
          <li><strong>20 V Input:</strong> USB-C PD via CH221K negotiates power delivery</li>
          <li><strong>5 V Buck:</strong> AP3503 buck converter powers downstream electronics</li>
          <li><strong>3.3 V LDO:</strong> AP2112K powers ESP32 core logic</li>
        </ul>

        <h3>Connectors</h3>
        <ul>
          <li><strong>USB-C Port:</strong> PD power source</li>
          <li><strong>Prusa Tile Connector:</strong> 4-pin Molex for heating tile</li>
          <li><strong>UART Test Pads:</strong> For flashing and debugging</li>
          <li><strong>MOSFET Output:</strong> Controlled power output to heating tile</li>
        </ul>

        <h2>Performance Specifications</h2>
        <ul>
          <li><strong>Input Voltage:</strong> 5 V to 20 V via USB-C PD negotiation</li>
          <li><strong>Buck Converter:</strong> 5 V output at up to 3 A</li>
          <li><strong>LDO Output:</strong> 3.3 V at 500 mA</li>
          <li><strong>Detection Range:</strong> Hall effect sensor sensitivity to magnetic field</li>
          <li><strong>Wireless:</strong> Wi-Fi and Bluetooth LE</li>
          <li><strong>Form Factor:</strong> Compact PCB designed for Prusa-style coasters</li>
        </ul>

        <h2>Applications</h2>
        <p>This PCB is ideal for:</p>
        <ul>
          <li><strong>Smart Coasters:</strong> Intelligent beverage warming systems</li>
          <li><strong>Desk Accessories:</strong> Custom workspace heating solutions</li>
          <li><strong>IoT Integration:</strong> Connected smart home devices</li>
          <li><strong>Learning Platforms:</strong> ESP32-S3 development and experimentation</li>
        </ul>

        <h2>Getting Started</h2>
        <p>Flash firmware using USB-to-UART interface connected to ESP32-S3. Press BOOT and tap RST to enter download mode:</p>
        <pre><code>idf.py set-target esp32s3
idf.py build
idf.py -p /dev/ttyUSB0 flash monitor</code></pre>

        <h2>Testing & Validation</h2>
        <ul>
          <li><strong>Power Delivery Testing:</strong> Verified USB-C PD negotiation up to 20 V</li>
          <li><strong>Weight Detection:</strong> Hall effect sensor sensitivity testing with various weights</li>
          <li><strong>Thermal Testing:</strong> Heating tile control under various load conditions</li>
          <li><strong>Wireless Testing:</strong> Wi-Fi and BLE connectivity and range testing</li>
          <li><strong>Power Efficiency:</strong> Buck converter efficiency measurements</li>
        </ul>

        <p>This project showcases how modern ESP32 microcontrollers can enable smart, connected devices with efficient power management and intelligent sensing capabilities.</p>
      </div>
    </article>
  )
}
